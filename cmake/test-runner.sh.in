#!/bin/bash
# This file is automatically generated, do not edit
PRODUCT=@product@
TESTNAME=@product@
echo "--- $TESTNAME ---"
SNAPSHOT=@snapshot@

# HACK: Old RHEL may be missing realpath
realpath_stub() {
    readlink -f -- "$@"
}

[ -x "$(command -v realpath)" ] || alias realpath=realpath_stub

# END OF HACK

# Work-around ccache bugs on RHEL
export CCACHE_NOSTATS True

prepare_log_directory()
{
    [ -d $TESTNAME.logs ] && rm -rf $TESTNAME.logs
    mkdir -p $TESTNAME.logs
    ln -sf `realpath $1` $TESTNAME.logs/runner
    cd $TESTNAME.logs
    WDIR="`pwd`"
}

WDIR=`pwd`
prepare_log_directory $0

echo "[>] Working directory: $WDIR"
if [ ! -z "$IRUN_EXTRA_FLAGS" ]; then
    echo "[>] Picked up extra irun flags from environment: $IRUN_EXTRA_FLAGS"
fi

cd $WDIR

#Copy provided files to test directory
[ -f @CMAKE_BINARY_DIR@/files-$TESTNAME ] && . @CMAKE_BINARY_DIR@/files-$TESTNAME

# Store some server
uname -a > serverinfo.txt
free >> serverinfo.txt
cat /proc/loadavg >> serverinfo.txt

#setup the environment
@TARGET_ENVIRONMENT@
@TARGET_PREPCMD@

@PYTHON_EXECUTABLE@ @CMAKE_SOURCE_DIR@/rumboot-tools/rumboot_xrun.py -f @CMAKE_BINARY_DIR@/@product@@_suffix@ @_plusargs@ $* $IRUN_EXTRA_FLAGS
code=$?
echo -e "[!] Exit code: $code"
exit $code
