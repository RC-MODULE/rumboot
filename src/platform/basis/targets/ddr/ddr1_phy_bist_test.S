
#include <regs/regs_ddr.h>
#include <platform/devices.h>

.global main

test_stage_pass_GPIO:
    ADD R5, #1
    BX LR
    
test_stage_fail_GPIO:
    BX LR

ddr3_ctrl_data:
.word 0b00000000000000000000011000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000001000
.word 0b00000000000000000000000010100000
.word 0b00000000000000000000000110010000
.word 0b00000100000000000000100000010110
.word 0b00011100001001110000010100000100
.word 0b00000110000101100000110000000110
.word 0b00000000000000000000110000000100
.word 0b00000100000000001101101101100000
.word 0b00001100000011000000000000000101
.word 0b00011000000000010000000100000000
.word 0b00000001000000000000110000000011
.word 0b00000000000000000000000000000001
.word 0b00000000000000001101000000000000
.word 0b00000000000000000001100001011000
.word 0b00000000000101000000000000000101
.word 0b00000000110110000000001000000000
.word 0b00000011000000010000000000000000
.word 0b00000000000010000000100000000000
.word 0b00000111000000110000001000000000
.word 0b00000000000000000000001100011111
.word 0b00000000000001110000000000000100
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000011000111000000000000
.word 0b00000000000110000000000001000110
.word 0b00000000000000000000000000000000
.word 0b00000000000000100000000000000000
.word 0b00000000010000000000000100000000
.word 0b00000000000000000000001000000000
.word 0b00000000000000000000000001000000
.word 0b00000000000000000000000000000000
.word 0b11111111000010100000000000000000
.word 0b00000001000000010000000111111111
.word 0b00000001000000010000000100000001
.word 0b00000000000000010000100000000001
.word 0b00000000000000000000110000000000
.word 0b00000001000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000111000000000000000000000000
.word 0b00000000000000000000000100000110
.word 0b00000000000000000000000000000010
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00101000000011010000000000000000
.word 0b00000001000000000000000000000000
.word 0b00000001000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000001000000010000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000001000000000000000000000001
.word 0b00000000000000000000000000000001
.word 0b00000000000000000000000000000000
.word 0b00000000000000000001011100000000
.word 0b00000000001100001011000000000101
.word 0b00000010000000000000001000000000
.word 0b00000010000000000000001000000000
.word 0b00000000000000000011000010110000
.word 0b00000000000000011110011011100000
.word 0b00000010000000100000011100001001
.word 0b00000000000101000000001100000011
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000001010000000011
.word 0b00000000000000000000011111010000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00001010000000010000000000000000
.word 0b00000000000000000000000100000110
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000010000000000000000000
.word 0b00000000011001000000001111101000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000

ddr3_phy_slice_data:
.word 0b01110110010101000011001000010000
.word 0b00000000000001001100000000001000
.word 0b00000000000000000000000010011001
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000100000000
.word 0b00000001011001100101010101010101
.word 0b00000000011001100101010101010101
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000100000000
.word 0b00000000000101110000000011000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000100000010000000000000000000
.word 0b00000100000010000000010000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00100000000000000000000000000100
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000010100000000000001010000000
.word 0b00000010100000000000001010000000
.word 0b00000010100000000000001010000000
.word 0b00000010100000000000001010000000
.word 0b00000000000000000000001010000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000100000000000000010000000
.word 0b00000000000000010000000010011001
.word 0b00000000000000000000000111010000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000100
.word 0b01010001010000010100000101010010
.word 0b10000000100000000100000101000001
.word 0b00000001000000100000000000000000
.word 0b00001000000000000001000000000000
.word 0b00001100000001010011111001000010
.word 0b00000000000011110000110000001111
.word 0b00000001000000000000000101000000
.word 0b00000000000000000000000000001100

ddr3_phy_cmn_data:
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000001010000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000100000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000100000001
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000100010000001001100100
.word 0b00000000000000000000000100100010
.word 0b00000000000000000000000000000000
.word 0b00000000000000010000000000000000
.word 0b00000001000000000000000100000000
.word 0b00000000000000000000000100000000
.word 0b01000010000010000000000000010000
.word 0b00000000000000010000000000111110
.word 0b00000001000000000000000100000000
.word 0b00000001000000000000000100000000
.word 0b00000001000000000000000100000000
.word 0b00000000000000000000100100100100
.word 0b00000000000000000000000000000000
.word 0b00000011000000100000000000000000
.word 0b00000000000101000000000000000000
.word 0b00000000000000000000000000010001
.word 0b00000000000000000000000000010001
.word 0b00000000000000000000010000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000010001
.word 0b00000000000000000000000000010001
.word 0b00000000000000000100010000010000
.word 0b00000000000000000100010000010000
.word 0b00000000000000000100010000010000
.word 0b00000000000000000100010000010000
.word 0b00000000000000000100010000010000
.word 0b00000000000000000000000000010001
.word 0b00000000000000000100010000010000
.word 0b00000000000000000000000000010001
.word 0b00000000000000000100010000010000
.word 0b00000000000000000000000000010001
.word 0b00000000000000000100010000010000
.word 0b00000000000000000000000000010001
.word 0b00000000000000000100010000010000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000100
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000100001000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000001
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000000000000000000000000000000
.word 0b00000100000001110000000100000000
.word 0b00000000000000000000000000000010
.word 0b00000000000000000000000000000000

/**********************************************************
 *    This is DDR Phy (top and cluster) bist test         *
 *    Its duration is < 1.5ms on rtl modeling             *
 *********************************************************/
main:
DDR_phy_bist:
    PUSH {LR}
    /**************************************************/
    /*    R5 will be used as global variable          */
    /*    dont use it as general registers            */
    /*    after this test GPIO: 0 -> (11*5=55)        */
    /**************************************************/
    MOV  R5, #0
    
    LDR R7, =DDR1_BASE
/***********************     DDR Phy initialisation     ********************/
    LDR R1, =ddr3_ctrl_data
    LDR R3, =0x0
    ADD R3, R7
    LDR R4, =0x184
    ADD R4, R7
DDR_ctrl_cycle:
        LDR R2, [R1], #4
        STR R2, [R3], #4
        CMP R4, R3
        BNE DDR_ctrl_cycle
    
    LDR R6, =0x0
DDR_all_slice_cycle:
    LDR R1, =ddr3_phy_slice_data
    LDR R3, =DENALI_PHY_BASE
    ADD R3, R7
    ADD R3, R6
    ADD R4, R3, #0x124
DDR_slice_cycle:
        LDR R2, [R1], #4
        STR R2, [R3], #4
        CMP R4, R3
        BNE DDR_slice_cycle
    ADD R6, #0x200
    CMP R6, #0x600
    BNE DDR_all_slice_cycle
    
    
    LDR R1, =ddr3_phy_cmn_data
    LDR R3, =DENALI_PHY_BASE + DENALI_PHY_384
    ADD R3, R7
    LDR R4, =DENALI_PHY_BASE + 0x70C
    ADD R4, R7
DDR_cmn_cycle:
        LDR R2, [R1], #4
        STR R2, [R3], #4
        CMP R4, R3
        BNE DDR_cmn_cycle
    
    /**************************************************/
    /*    Start DDR                                   */
    /*    or skip, if it is already done              */
    /**************************************************/
    LDR R1, =DENALI_CTL_00
    ADD R1, R7
    LDR R2, [R1]
    AND R2, #0x1
    CMP R2, #0x1
    BEQ DDR_ready

    LDR R1, =DENALI_CTL_00
    ADD R1, R7
    LDR R2, =0b00000000000000000000011000000001
    STR R2, [R1]
    
    LDR R1, =DENALI_CTL_94
    ADD R1, R7
DDR_wait_ready:
        LDR R2, [R1]
        AND R2, #0x800
        CMP R2, #0x0
        BEQ DDR_wait_ready
DDR_ready:
    
    /************************************************************/
    /*             This part is probably not needed             */
    /************************************************************/
    LDR R3, =150*2
    BL Delay_cycle
    
    LDR R1, =DENALI_PHY_BASE + DENALI_PHY_387
    ADD R1, R7
    LDR R2, =0x1
    STR R2, [R1]
    /************************************************************/
/***********************   DDR Data slices loopback test  ********************/
    LDR R1, =DENALI_PHY_BASE + DENALI_PHY_07
    ADD R1, R7
    LDR R6, =DENALI_PHY_BASE + DENALI_PHY_07 + 0x600
    ADD R6, R7
    
DDR_lpbk_data_slice:
        LDR R2, =0b00100001011001100101010101010101
        STR R2, [R1]
        
        LDR R3, =10
        BL Delay_cycle
        
        LDR R3, =0b10100001011001100101010101010101
        STR R3, [R1]
        
DDR_lpbk_data_slice_wait:
            LDR R4, [R1, #0x2C]
            AND R4, #0x200000
            CMP R4, #0x0
            BEQ DDR_lpbk_data_slice_wait
        
        STR R2, [R1]
        /**********    Checking results    **********/
        LDR R4, [R1, #0x2C]
        AND R4, #0x00180000
        CMP R4, #0x0
        BLNE test_stage_fail_GPIO
        BLEQ test_stage_pass_GPIO
        /********************************************/
        ADD R1, #0x200
        CMP R1, R6
        BNE DDR_lpbk_data_slice
/*********************** DDR Address/Control slice loopback test********************/
    LDR R1, =DENALI_PHY_BASE + DENALI_PHY_441
    ADD R1, R7
    LDR R2, =0b00000000000011000111111100000000
    STR R2, [R1]
    
    LDR R3, =10
    BL Delay_cycle
   
    LDR R2, =0b00000000001011000111111100000000
    STR R2, [R1]
    
DDR_lpbk_addrctrl_wait:
        LDR R2, [R1, #0x8]
        AND R2, #0x000020
        CMP R2, #0x0
        BEQ DDR_lpbk_addrctrl_wait
    /**********    Checking results    **********/
    LDR R2, [R1, #0x8]
    AND R2, #0x010
    CMP R2, #0x0
    BLNE test_stage_fail_GPIO
    BLEQ test_stage_pass_GPIO
    /********************************************/
/*********************** DDR Memory Clock Slice loopback test********************/
    LDR R1, =DENALI_PHY_BASE + DENALI_PHY_444
    ADD R1, R7
    LDR R2, =0b00000000000001000000000100000000
    STR R2, [R1]
    
    LDR R3, =10
    BL Delay_cycle
   
    LDR R2, =0b00000000000011000000000100000000
    STR R2, [R1]
    
DDR_lpbk_clock_wait:
        LDR R2, [R1, #0x4]
        AND R2, #0x000002
        CMP R2, #0x0
        BEQ DDR_lpbk_clock_wait
    /**********    Checking results    **********/
    LDR R2, [R1, #0x4]
    AND R2, #0x01
    CMP R2, #0x0
    BLNE test_stage_fail_GPIO
    BLEQ test_stage_pass_GPIO
    /********************************************/
/***********************       Data slices ddl test       ********************/
    LDR R1, =DENALI_PHY_BASE + DENALI_PHY_30
    ADD R1, R7
    LDR R6, =DENALI_PHY_BASE + DENALI_PHY_30 + 0x600
    ADD R6, R7
DDR_ddl_data_slice:
        LDR R2, =0b00000000000000000000000001000011
        STR R2, [R1]
DDR_ddl_data_slice_wait:
            LDR R4, [R1, #0x4]
            AND R4, #0x1
            CMP R4, #0x0
            BEQ DDR_ddl_data_slice_wait
        /**********    Checking results    **********/
        LDR R4, [R1, #0x4]
        AND R4, #0xFFFFFFFE
        CMP R4, #0x0
        BLNE test_stage_fail_GPIO
        BLEQ test_stage_pass_GPIO
        /********************************************/
        ADD R1, #0x200
        CMP R1, R6
        BNE DDR_ddl_data_slice
/*********************** DDR Address/Control slice ddl test********************/
    LDR R1, =DENALI_PHY_BASE + DENALI_PHY_443
    ADD R1, R7
    LDR R2, =0b00000000000000000000000100100001
    STR R2, [R1, #0x10]
    LDR R2, =0b00000000000000000000000011111111
    STR R2, [R1, #0xC]
DDR_ddl_addrctrl_wait:
        LDR R2, [R1]
        AND R2, #0x000001
        CMP R2, #0x0
        BEQ DDR_ddl_addrctrl_wait
    /**********    Checking results    **********/
    LDR R2, [R1]
    LDR R3, =0x00FFFFFE
    AND R2, R3
    CMP R2, #0x0
    BLNE test_stage_fail_GPIO
    BLEQ test_stage_pass_GPIO
    /********************************************/
    
/**********************************************************/
DDR_lpbk_exit:
    CMP R5, #9
    LDREQ R0, =0x0
    MOVNE R0, R5
    POP {PC}
DDR_infinite_cycle:
    B DDR_infinite_cycle
/**********************************************************/
Delay_cycle:
    SUB R3, #1
    CMP R3, #0
    BNE Delay_cycle
    BX LR
/**********************************************************/
    